create view one_6 as
with tmp as
(select distinct on(customer_id) customer_id, article_id from transactions_train 
where t_dat >= date_trunc('month', timestamp '2018-12-31 00:00') 
	      and t_dat <= date_trunc('month', timestamp '2018-12-31 00:00') + interval '1 month - 1 day'
), tt1 as

(select customer_id, t_dat from transactions_train 
where t_dat >= date_trunc('month', timestamp '2018-12-31 00:00') 
	      and t_dat <= date_trunc('month', timestamp '2018-12-31 00:00') + interval '1 month - 1 day')
, tmp2 as
(select  a1.product_group_name, a1.article_id from articles as a1 
right join tmp t1 on a1.article_id = t1.article_id)
, tmp3 as
(select distinct * from tmp
left join tmp2 using(article_id))
, tmp4 as
(select * from tt1
left join tmp3 using(customer_id))

, tmp5 as
(select distinct on(customer_id) customer_id, count(product_group_name) as product_group_name from tmp4
group by customer_id, t_dat)
 
select * from one_5
left join tmp5 using(customer_id)
